@model CheckoutViewModel
@{
    ViewData["Title"] = "Finalizar Compra";
}

<div id="success-popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1060; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease;">
    <div style="background-color: white; padding: 2.5rem; text-align: center; border-radius: var(--bs-border-radius); width: 90%; max-width: 400px;">
        <div style="width: 80px; height: 80px; margin: 0 auto; background-color: #16a34a; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i data-lucide="check" style="color: white; width: 40px; height: 40px;"></i>
        </div>
        <h3 class="fw-bold mt-3">Compra Realizada!</h3>
        <p class="text-muted">Seu pedido foi processado com sucesso. Em breve você receberá um e-mail com todos os detalhes.</p>
        <a href="@Url.Action("Index", "Home")" class="btn btn-primary mt-3">Voltar para a Home</a>
    </div>
</div>

<div class="main-content">
<div class="container py-5">
    <h1 class="h2 fw-bold mb-5">Finalizar Compra</h1>
    <div class="row g-5">
        <div class="col-lg-8">
            <div class="checkout-progress-bar mb-5">
                <div class="step active" data-step="1"><div class="step-icon"><span>1</span><i data-lucide="check" style="display:none;"></i></div>Endereço</div>
                <div class="flex-grow-1 step-line"><hr></div>
                <div class="step" data-step="2"><div class="step-icon"><span>2</span><i data-lucide="check" style="display:none;"></i></div>Entrega</div>
                <div class="flex-grow-1 step-line"><hr></div>
                <div class="step" data-step="3"><div class="step-icon"><span>3</span><i data-lucide="check" style="display:none;"></i></div>Pagamento</div>
            </div>

            <div id="address-step" class="checkout-step">
                <h5 class="fw-bold mb-3">Endereço de Entrega</h5>
                <div class="card"><div class="card-body p-4"><div class="row g-3">
                    <div class="col-md-5"><label for="cep" class="form-label">CEP</label><div class="input-group"><input type="text" class="form-control" id="cep" placeholder="00000-000" maxlength="9"><button class="btn btn-outline-secondary" type="button" id="cep-search-btn">Buscar</button></div></div>
                    <div class="col-md-7"><label for="address" class="form-label">Endereço</label><input type="text" class="form-control" id="address" placeholder="Rua, avenida..."></div>
                    <div class="col-md-4"><label for="number" class="form-label">Número</label><input type="text" class="form-control" id="number"></div>
                    <div class="col-md-8"><label for="complement" class="form-label">Complemento</label><input type="text" class="form-control" id="complement" placeholder="Apt, bloco, casa..."></div>
                    <div class="col-12"><label for="neighborhood" class="form-label">Bairro</label><input type="text" class="form-control" id="neighborhood"></div>
                    <div class="col-md-6"><label for="city" class="form-label">Cidade</label><input type="text" class="form-control" id="city"></div>
                    <div class="col-md-6"><label for="state" class="form-label">Estado</label><input type="text" class="form-control" id="state"></div>
                </div></div></div>
                <div class="d-flex justify-content-end mt-4"><button class="btn btn-primary" onclick="navigateToStep(2)">Continuar para Entrega</button></div>
            </div>

            <div id="delivery-step" class="checkout-step d-none">
                <h5 class="fw-bold mb-3">Opções de Entrega</h5>
                <div class="vstack gap-3">
                    <label class="selectable-option"><input type="radio" name="deliveryOption" value="standard" checked><div class="p-3 d-flex justify-content-between align-items-center"><div><span class="fw-semibold">Entrega Padrão</span><small class="d-block text-muted">Entrega pelos Correios<br><strong class="text-danger">5-8 dias úteis</strong></small></div><span class="fw-bold">R$ 29,90</span></div></label>
                    <label class="selectable-option"><input type="radio" name="deliveryOption" value="express"><div class="p-3 d-flex justify-content-between align-items-center"><div><span class="fw-semibold">Entrega Expressa</span><small class="d-block text-muted">Entrega prioritária<br><strong class="text-danger">2-3 dias úteis</strong></small></div><span class="fw-bold">R$ 49,90</span></div></label>
                </div>
                <div class="d-flex justify-content-between mt-4"><button class="btn btn-outline-secondary" onclick="navigateToStep(1)">Voltar</button><button class="btn btn-primary" onclick="navigateToStep(3)">Continuar para Pagamento</button></div>
            </div>

            <div id="payment-step" class="checkout-step d-none">
                <h5 class="fw-bold mb-3">Forma de Pagamento</h5>
                <div class="vstack gap-3">
                    <label class="selectable-option"><input type="radio" name="paymentMethod" value="card" checked><div class="p-3"><i data-lucide="credit-card" class="me-2"></i>Cartão de Crédito</div></label>
                   <label class="selectable-option">
                        <input type="radio" name="paymentMethod" value="pix">
                        <div class="p-3"><i data-lucide="dollar-sign" class="me-2"></i>PIX - 5% de desconto</div>
                    </label>
                    <label class="selectable-option"><input type="radio" name="paymentMethod" value="boleto"><div class="p-3"><i data-lucide="barcode" class="me-2"></i>Boleto Bancário</div></label>
                </div>
                <div id="card-details" class="card mt-4"><div class="card-body p-4"><div class="row g-3">
                    <div class="col-12"><label class="form-label">Número do Cartão</label><input type="text" class="form-control" placeholder="0000 0000 0000 0000"></div>
                    <div class="col-12"><label class="form-label">Nome do Titular</label><input type="text" class="form-control" placeholder="Como impresso no cartão"></div>
                    <div class="col-md-6"><label class="form-label">Validade</label><input type="text" class="form-control" placeholder="MM/AA"></div>
                    <div class="col-md-6"><label class="form-label">CVV</label><input type="text" class="form-control" placeholder="123"></div>
                </div></div></div>
                <div class="d-flex justify-content-between mt-4"><button class="btn btn-outline-secondary" onclick="navigateToStep(2)">Voltar</button><button id="finalize-order-btn" type="button" class="btn btn-success btn-lg"><i data-lucide="lock" class="me-2" style="width:16px;"></i> Finalizar Pedido</button></div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="summary-card">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-4">Resumo do Pedido</h5>
                        @foreach (var item in Model.Items)
                        {
                            <div class="d-flex align-items-center border-bottom pb-3 mb-3">
                                <img src="@item.ImageUrl" class="rounded me-3" style="width: 60px;" alt="@item.Name">
                                <div><h6 class="mb-0 small">@item.Name</h6><p class="text-muted small mb-0">Qtd: @item.Quantity</p><p class="fw-bold mb-0 product-price">@item.TotalPrice.ToString("C")</p></div>
                            </div>
                        }
                        <div class="d-flex justify-content-between mb-2 text-muted"><span>Subtotal</span><span>@Model.Subtotal.ToString("C")</span></div>
                        <div class="d-flex justify-content-between mb-3 text-muted"><span>Frete</span><span class="product-price">@Model.Shipping.ToString("C")</span></div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold h5 mb-4"><span>Total</span><span class="product-price">@Model.Total.ToString("C")</span></div>
                        <ul class="info-list list-unstyled text-muted small">
                            <li class="mb-2"><i data-lucide="shield-check" class="text-dark"></i> Seus dados estão protegidos</li>
                            <li class="mb-2"><i data-lucide="truck" class="text-dark"></i> Entrega garantida</li>
                            <li><i data-lucide="refresh-cw" class="text-dark"></i> Troca em até 30 dias</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

@section Scripts {
<script>
    function navigateToStep(stepNumber) {
        document.querySelectorAll('.checkout-step').forEach(step => step.classList.add('d-none'));
        document.getElementById(getStepId(stepNumber)).classList.remove('d-none');
        
        const progressSteps = document.querySelectorAll('.checkout-progress-bar .step');
        progressSteps.forEach((step, index) => {
            const stepIcon = step.querySelector('.step-icon');
            const stepNum = stepIcon.querySelector('span');
            const stepCheck = stepIcon.querySelector('i');

            step.classList.remove('active', 'completed');

            if ((index + 1) < stepNumber) {
                step.classList.add('completed');
                stepNum.style.display = 'none';
                stepCheck.style.display = 'block';
            } else if ((index + 1) === stepNumber) {
                step.classList.add('active');
                stepNum.style.display = 'block';
                stepCheck.style.display = 'none';
            } else {
                stepNum.style.display = 'block';
                stepCheck.style.display = 'none';
            }
        });
        lucide.createIcons();
    }

    function getStepId(stepNumber) {
        if (stepNumber === 1) return 'address-step';
        if (stepNumber === 2) return 'delivery-step';
        if (stepNumber === 3) return 'payment-step';
    }

    document.addEventListener('DOMContentLoaded', function() {
    
        document.getElementById('cep-search-btn')?.addEventListener('click', function() {
            let cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('address').value = data.logradouro;
                            document.getElementById('neighborhood').value = data.bairro;
                            document.getElementById('city').value = data.localidade;
                            document.getElementById('state').value = data.uf; 
                            document.getElementById('number').focus();
                        } else { alert('CEP não encontrado.'); }
                    });
            }
        });

    
        const finalizeBtn = document.getElementById('finalize-order-btn');
        const popupOverlay = document.getElementById('success-popup-overlay');
        
        finalizeBtn?.addEventListener('click', function() {
            fetch('@Url.Action("FinalizeOrder", "Checkout")', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        popupOverlay.style.display = 'flex';
                        setTimeout(() => popupOverlay.style.opacity = '1', 10);
                        lucide.createIcons(); 
                    } else {
                        alert('Ocorreu um erro ao finalizar o pedido: ' + data.message);
                    }
                });
        });
    });
</script>
}