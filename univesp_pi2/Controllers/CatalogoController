using Microsoft.AspNetCore.Mvc;
using univesp_pi2.Models;
using System.Collections.Generic;
using System.Linq;

namespace univesp_pi2.Controllers
{
    
    public class CatalogoController : Controller
    {
        
        public IActionResult Index(CatalogViewModel model)
        {
        
            var allProducts = GetProductsMock();
            model.AvailableBrands = allProducts.Select(p => p.Brand).Distinct().ToList();

            var filteredProducts = allProducts.AsEnumerable(); 

         
            if (!string.IsNullOrEmpty(model.CurrentCategory))
            {
                if (model.CurrentCategory.Equals("Ofertas", System.StringComparison.OrdinalIgnoreCase))
                {
                    filteredProducts = filteredProducts.Where(p => p.IsOnOffer);
                }
                else
                {
                    filteredProducts = filteredProducts.Where(p => 
                        p.Category.Equals(model.CurrentCategory, System.StringComparison.OrdinalIgnoreCase));
                }
            }
            
   
            if (!string.IsNullOrEmpty(model.CurrentSearch))
            {
                string search = model.CurrentSearch.ToLower();
                filteredProducts = filteredProducts.Where(p => 
                    p.Name.ToLower().Contains(search) ||
                    p.Code.ToLower().Contains(search) ||
                    p.Brand.ToLower().Contains(search));
            }

          
            if (!string.IsNullOrEmpty(model.CurrentBrand) && model.CurrentBrand != "Todas")
            {
                filteredProducts = filteredProducts.Where(p => 
                    p.Brand.Equals(model.CurrentBrand, System.StringComparison.OrdinalIgnoreCase));
            }
            
          
            if (model.InStockOnly)
            {
                filteredProducts = filteredProducts.Where(p => p.IsInStock);
            }

          
            filteredProducts = filteredProducts.Where(p => model.MinPrice == 0.00m || (p.FinalPrice >= model.MinPrice && p.FinalPrice <= model.MaxPrice));
            
     
            filteredProducts = model.SortBy switch
            {
                "PriceLow" => filteredProducts.OrderBy(p => p.FinalPrice),
                "PriceHigh" => filteredProducts.OrderByDescending(p => p.FinalPrice),
                "Rating" => filteredProducts.OrderByDescending(p => p.Rating),
                _ => filteredProducts.OrderBy(p => p.Name) 
            };

           
            model.Products = filteredProducts.ToList();
            
     
            return View("Index", model); 
        }

       
        private List<Product> GetProductsMock()
        {
            return new List<Product>
            {
                new Product { Id = 1, Name = "Bateria Automotiva 60Ah", Code = "MOU-BA-004", Brand = "Moura", Category = "Elétrica", Price = 350.00m, DiscountPrice = 289.90m, Stock = 15, ImageUrl = "/images/bateria.jpg", Rating = 4.7, ReviewCount = 167 },
                new Product { Id = 2, Name = "Pastilha de Freio Dianteira", Code = "BOS-PF-001", Brand = "Bosch", Category = "Freios", Price = 120.00m, DiscountPrice = 89.90m, Stock = 50, ImageUrl = "/images/pastilha.jpg", Rating = 4.5, ReviewCount = 128 },
                new Product { Id = 3, Name = "Vela de Ignição Iridium", Code = "NGK-VI-006", Brand = "NGK", Category = "Motor", Price = 55.00m, DiscountPrice = 45.90m, Stock = 0, ImageUrl = "/images/vela.jpg", Rating = 4.9, ReviewCount = 312 },
                new Product { Id = 4, Name = "Disco de Freio Ventilado", Code = "TRW-DF-005", Brand = "TRW", Category = "Freios", Price = 180.00m, DiscountPrice = 0, Stock = 10, ImageUrl = "/images/disco.jpg", Rating = 4.4, ReviewCount = 92 },
                new Product { Id = 5, Name = "Filtro de Óleo do Motor", Code = "MAN-FO-002", Brand = "Mann-Filter", Category = "Fluidos", Price = 32.00m, DiscountPrice = 24.90m, Stock = 200, ImageUrl = "/images/filtro.jpg", Rating = 4.8, ReviewCount = 254 },
                new Product { Id = 6, Name = "Amortecedor Traseiro", Code = "MON-AT-003", Brand = "Monroe", Category = "Suspensão", Price = 250.00m, DiscountPrice = 189.90m, Stock = 5, ImageUrl = "/images/amortecedor.jpg", Rating = 4.6, ReviewCount = 89 },
                new Product { Id = 7, Name = "Óleo Motor 5W30 Sintético", Code = "CAS-OM-008", Brand = "Castrol", Category = "Fluidos", Price = 60.00m, DiscountPrice = 45.90m, Stock = 150, ImageUrl = "/images/oleo.jpg", Rating = 4.8, ReviewCount = 445 },
                new Product { Id = 8, Name = "Correia Dentada", Code = "GAT-CD-010", Brand = "Gates", Category = "Motor", Price = 150.00m, DiscountPrice = 129.90m, Stock = 30, ImageUrl = "/images/correia.jpg", Rating = 4.5, ReviewCount = 178 }
            };
        }
    }
}